#!/bin/bash

[ -s "$PWD/config" ] || \
(echo 'From the script directory, run: report/summary'; exit)
. $PWD/config # import config

SQLPROJECTS="select distinct name from Projects"
SQLSELECTORS="select distinct name from Selectors"
SQLJOIN="select distinct name from Selectors join Projects using (name)"
SQLJOINHP="select distinct name, homepage from Selectors join Projects using (name)"
NOHPCONDITION="(homepage is null or homepage = '')"
SFHPCONDITION="(homepage like '%sourceforge.net%' or homepage like '%sf.net%')"

SQL="$SQLJOINHP where not $SFHPCONDITION and not $NOHPCONDITION"
sqlite3 $DB "select name from ($SQL);" | sort | \
diff --changed-group-format='%=' --unchanged-group-format='' \
- $LISTDATADIR/references.list > $LISTDATADIR/noreferences.list


function report
{
  FILE="$LISTDATADIR/$1.list"
  [ -z "$SQL" ] || sqlite3 $DB "$SQL;" > $FILE
  echo "$DESCRIPTION" $(cat $FILE | wc -l) "($1)"
}

SQL="$SQLPROJECTS"
DESCRIPTION='Projects (SourceForge):'
report 'projects'

SQL="$SQLSELECTORS"
DESCRIPTION='Selectors (Debian 5.0.6-i386-main):'
report 'selectors'

SQL="$SQLPROJECTS union $SQLSELECTORS except $SQLJOIN"
DESCRIPTION='Identifiers (project/selector) symmetric difference:'
report 'difference'

SQL="$SQLJOIN"
DESCRIPTION='Identifiers (project/selector) intersection:'
report 'intersection'

SQL="$SQLJOINHP where $NOHPCONDITION"
DESCRIPTION='... no homepage (seletor):'
report 'nohomepage'

SQL="$SQLJOINHP where not $NOHPCONDITION"
DESCRIPTION='... with homepage (seletor):'
report 'homepage'

SQL="$SQLJOINHP where $SFHPCONDITION"
DESCRIPTION='... ... with SF substring (seletor URL):'
report 'subsourceforge'

SQL="$SQLJOINHP where not $SFHPCONDITION and not $NOHPCONDITION"
DESCRIPTION='... ... no SF substring (seletor URL):'
report 'nosubsourceforge'

SQL=''
DESCRIPTION='... ... ... with references to counterpart (selector/projects homepages):'
report 'references'

SQL=''
DESCRIPTION='... ... ... no references to counterpart (selector/projects homepages):'
report 'noreferences'

